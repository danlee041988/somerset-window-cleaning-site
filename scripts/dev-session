#!/usr/bin/env bash
# One-writer (Codex) + many-watchers tmux layout
set -Eeuo pipefail

# Always start in project root
cd "$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

# ---- tweak via env vars when launching (see examples below) ----
SESSION="${SESSION:-dev}"

# Prefer 'codex'; fall back to 'cod' if that's what you installed
if command -v codex >/dev/null 2>&1; then
  AGENT_CMD_DEFAULT="codex"
elif command -v cod >/dev/null 2>&1; then
  AGENT_CMD_DEFAULT="cod"
else
  AGENT_CMD_DEFAULT="$SHELL"   # open a shell if Codex not found
fi
AGENT_CMD="${AGENT_CMD:-$AGENT_CMD_DEFAULT}"

DEV_CMD="${DEV_CMD:-npm run dev}"
TEST_CMD="${TEST_CMD:-npm test -- --watch}"                 # vitest/jest watch
TSC_CMD="${TSC_CMD:-npx tsc -w --noEmit}"                   # or: next typecheck
LINT_CMD="${LINT_CMD:-npx eslint . --ext .js,.jsx,.ts,.tsx --cache --watch}"
LOGS_CMD="${LOGS_CMD:-(tail -f logs/*.log 2>/dev/null || printf 'no logs\n'; exec $SHELL)}"
# ---------------------------------------------------------------

# Reattach if already running
if tmux has-session -t "$SESSION" 2>/dev/null; then
  exec tmux attach -t "$SESSION"
fi

# Window 'app', Pane 1 = Codex (the ONLY writer)
tmux new-session -d -s "$SESSION" -n app "$AGENT_CMD"

# Build a 2x3 grid (Codex + 5 watchers)
tmux split-window  -h -t "$SESSION:app.0"
tmux split-window  -v -t "$SESSION:app.1"
tmux split-window  -v -t "$SESSION:app.0"
tmux split-window  -h -t "$SESSION:app.2"
tmux split-window  -h -t "$SESSION:app.3"

tmux select-layout -t "$SESSION:app" tiled

mapfile -t panes < <(tmux list-panes -t "$SESSION:app" -F '#P')

COD_PANE=${panes[0]:-0}
DEV_PANE=${panes[1]:-1}
TEST_PANE=${panes[2]:-2}
TSC_PANE=${panes[3]:-3}
LINT_PANE=${panes[4]:-4}
LOGS_PANE=${panes[5]:-5}

tmux send-keys -t "$SESSION:app.$DEV_PANE" "$DEV_CMD"  C-m
tmux send-keys -t "$SESSION:app.$TEST_PANE" "$TEST_CMD" C-m
tmux send-keys -t "$SESSION:app.$TSC_PANE"  "$TSC_CMD"  C-m
tmux send-keys -t "$SESSION:app.$LINT_PANE" "$LINT_CMD" C-m
tmux send-keys -t "$SESSION:app.$LOGS_PANE" "$LOGS_CMD" C-m

tmux select-pane   -t "$SESSION:app.$COD_PANE"
tmux display-message "Panes: codex=$COD_PANE dev=$DEV_PANE test=$TEST_PANE types=$TSC_PANE lint=$LINT_PANE logs=$LOGS_PANE"
exec tmux attach -t "$SESSION"
