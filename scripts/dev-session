#!/usr/bin/env bash
# One-writer (Codex) + many-watchers tmux layout
set -Eeuo pipefail

# Always start in project root
cd "$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

# ---- tweak via env vars when launching (see examples below) ----
SESSION="${SESSION:-dev}"

# Prefer 'codex'; fall back to 'cod' if that's what you installed
if command -v codex >/dev/null 2>&1; then
  AGENT_CMD_DEFAULT="codex"
elif command -v cod >/dev/null 2>&1; then
  AGENT_CMD_DEFAULT="cod"
else
  AGENT_CMD_DEFAULT="$SHELL"   # open a shell if Codex not found
fi
AGENT_CMD="${AGENT_CMD:-$AGENT_CMD_DEFAULT}"

DEV_CMD="${DEV_CMD:-npm run dev}"
TEST_CMD="${TEST_CMD:-npm test -- --watch}"                 # vitest/jest watch
TSC_CMD="${TSC_CMD:-npx tsc -w --noEmit}"                   # or: next typecheck
LINT_CMD="${LINT_CMD:-npx eslint . --ext .js,.jsx,.ts,.tsx --cache --watch}"
LOGS_CMD="${LOGS_CMD:-(tail -f logs/*.log 2>/dev/null || printf 'no logs\n'; exec $SHELL)}"
# ---------------------------------------------------------------

# Reattach if already running
if tmux has-session -t "$SESSION" 2>/dev/null; then
  exec tmux attach -t "$SESSION"
fi

# Window 'app', Pane 1 = Codex (the ONLY writer)
tmux new-session -d -s "$SESSION" -n app "$AGENT_CMD"

# Build a 2x3 grid (Codex + 5 watchers)
for _ in 1 2 3 4 5; do
  tmux split-window -t "$SESSION:app"
done

tmux select-layout -t "$SESSION:app" tiled

mapfile -t pane_ids < <(tmux list-panes -t "$SESSION:app" -F '#{pane_id}')

if [ ${#pane_ids[@]} -lt 6 ]; then
  tmux kill-session -t "$SESSION"
  echo "tmux dev-session: expected 6 panes, got ${#pane_ids[@]}" >&2
  exit 1
fi

COD_PANE=${pane_ids[0]}
DEV_PANE=${pane_ids[1]}
TEST_PANE=${pane_ids[2]}
TSC_PANE=${pane_ids[3]}
LINT_PANE=${pane_ids[4]}
LOGS_PANE=${pane_ids[5]}

tmux send-keys -t "$DEV_PANE"  "$DEV_CMD"  C-m
tmux send-keys -t "$TEST_PANE" "$TEST_CMD" C-m
tmux send-keys -t "$TSC_PANE"  "$TSC_CMD"  C-m
tmux send-keys -t "$LINT_PANE" "$LINT_CMD" C-m
tmux send-keys -t "$LOGS_PANE" "$LOGS_CMD" C-m

tmux select-pane -t "$COD_PANE"
tmux display-message "Panes: codex=$COD_PANE dev=$DEV_PANE test=$TEST_PANE types=$TSC_PANE lint=$LINT_PANE logs=$LOGS_PANE"
exec tmux attach -t "$SESSION"
